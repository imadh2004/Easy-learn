<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Exams</title>
<style>
  body {
    font-family: 'Arial', sans-serif;
    background: linear-gradient(135deg, #f4f6f8 0%, #e8eff5 100%);
    margin: 0;
    padding: 0;
    min-height: 100vh;
  }
  .container {
    max-width: 900px;
    margin: 20px auto;
    padding: 20px;
  }
  h2 { text-align: center; color:#007bff; }
  .exam-card {
    background:#fff;
    padding:15px;
    margin:10px 0;
    border-radius:10px;
    box-shadow:0 4px 15px rgba(0,0,0,0.1);
    display:flex;
    justify-content: space-between;
    align-items:center;
  }
  .exam-card button {
    background:#007bff;
    color:#fff;
    border:none;
    padding:8px 15px;
    border-radius:6px;
    cursor:pointer;
    transition:0.3s;
  }
  .exam-card button:hover { background:#0056b3; }
  .question {
    background:#f9f9f9;
    padding:15px;
    margin:10px 0;
    border-radius:10px;
    border-left:5px solid #007bff;
  }
  .question b { display:block; margin-bottom:8px; }
  .options input[type="radio"] { margin-right:8px; }
  #timer { font-weight:bold; font-size:20px; color:#ff4d4d; text-align:center; margin:15px 0; }
  button.submit-btn {
    display:block;
    margin:20px auto;
    padding:12px 25px;
    background:#28a745;
    color:#fff;
    border:none;
    border-radius:8px;
    font-size:16px;
    cursor:pointer;
  }
  button.submit-btn:hover { background:#218838; }
  @media (max-width:600px) {
    .exam-card { flex-direction:column; align-items:flex-start; }
    .exam-card button { margin-top:10px; width:100%; }
  }
</style>
</head>
<body>
<div class="container">
  <h2>Exams</h2>
  <div id="examsList">Loading exams...</div>
  <div id="examContainer" style="display:none;">
    <div id="timer">Timer: --:--</div>
    <div id="examContent"></div>
    <button class="submit-btn" id="submitExamBtn">Submit Exam</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getFirestore, collection, getDocs, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey:"AIzaSyACtMRuTNPVqk15KUebcCccrqESv9hFEgE",
  authDomain:"science-cls.firebaseapp.com",
  projectId:"science-cls",
  appId:"1:778012932104:web:f997ad31edac581f0b79bd"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
let currentExamId = null;
let examData = null;
let timerInterval = null;

// Check student login
onAuthStateChanged(auth, async user => {
  if(!user) window.location.href = 'index.html';
  else {
    currentUser = user;
    loadExams();
  }
});

// Load available exams
async function loadExams() {
  const examsSnap = await getDocs(collection(db,"exams"));
  const studentSnap = await getDoc(doc(db,"students",currentUser.uid));
  const attempts = studentSnap.data()?.attempts || {};
  const examsList = document.getElementById("examsList");
  examsList.innerHTML = '';

  const exams = [];
  examsSnap.forEach(snap => exams.push({id:snap.id, ...snap.data()}));
  exams.sort((a,b)=>a.createdAt - b.createdAt);

  exams.forEach(exam => {
    const div = document.createElement("div");
    div.className = 'exam-card';
    let statusText = '';
    if(attempts[exam.id]) statusText = '✅ Already Attempted';
    else if(!exam.active) statusText = '❌ Not Active';
    else statusText = '';

    div.innerHTML = `<div><strong>${exam.title}</strong> ${statusText}</div>`;
    if(!attempts[exam.id] && exam.active){
      const btn = document.createElement("button");
      btn.textContent = 'Start';
      btn.onclick = () => startExam(exam.id, exam);
      div.appendChild(btn);
    }

    examsList.appendChild(div);
  });
}

// Start exam
async function startExam(examId, exam) {
  currentExamId = examId;
  examData = exam;

  // Count attempt immediately
  const studentRef = doc(db,"students",currentUser.uid);
  await updateDoc(studentRef, { [`attempts.${examId}`]: 0 });

  document.getElementById("examsList").style.display = 'none';
  const container = document.getElementById("examContainer");
  container.style.display = 'block';

  renderExamQuestions();
  startTimer(exam.duration);
}

// Render questions
function renderExamQuestions() {
  const examContent = document.getElementById("examContent");
  examContent.innerHTML = '';
  examData.questions.forEach((q,i)=>{
    const div = document.createElement("div");
    div.className = "question";
    div.innerHTML = `<b>Q${i+1}: ${q.q}</b>` +
      q.options.map((opt,j)=>`<div class="options"><input type="radio" name="q${i}" value="${j}"> ${opt}</div>`).join("");
    examContent.appendChild(div);
  });
}

// Timer
function startTimer(durationMinutes){
  const timerDiv = document.getElementById("timer");
  let time = durationMinutes*60;

  timerInterval = setInterval(()=>{
    let minutes = Math.floor(time/60);
    let seconds = time%60;
    timerDiv.textContent = `Time Remaining: ${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
    time--;

    if(time<0){
      clearInterval(timerInterval);
      submitExam();
    }
  },1000);
}

// Submit exam
async function submitExam() {
  clearInterval(timerInterval);
  let score=0;
  examData.questions.forEach((q,i)=>{
    const selected = document.querySelector(`input[name="q${i}"]:checked`);
    if(selected && parseInt(selected.value)===q.answer) score++;
  });

  const studentRef = doc(db,"students",currentUser.uid);
  await updateDoc(studentRef, { [`attempts.${currentExamId}`]: score });

  window.location.href = 'student-dashboard.html';
}

// Handle browser reload/close
window.addEventListener('beforeunload', async (e)=>{
  if(currentExamId){
    // auto submit answers
    await submitExam();
  }
});
document.getElementById("submitExamBtn").addEventListener('click', submitExam);

</script>
</body>
</html>
