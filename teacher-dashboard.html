<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Teacher Dashboard</title>

<!-- Chart -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body { font-family: Arial; background:#f4f6f8; padding:20px; }
section { background:white; padding:15px; margin:15px 0; border-radius:10px; }
input, select, button { padding:8px; margin:5px; }
table { width:100%; border-collapse:collapse; }
th,td { border:1px solid #ccc; padding:6px; text-align:left; }
</style>
</head>
<body>

<h2>Teacher Dashboard</h2>

<!-- ================= EXAM CONTROL ================= -->
<section>
<h3>Exams (Open / Close)</h3>
<div id="examList"></div>
</section>

<!-- ================= ANALYTICS ================= -->
<section>
<h3>Exam Analytics</h3>
<select id="analyticsExam"></select>
<button onclick="loadAnalytics()">View</button>
<div id="analytics"></div>
</section>

<!-- ================= STUDENT GRAPH ================= -->
<section>
<h3>Student Performance</h3>
<select id="studentSelect"></select>
<button onclick="loadStudentPerformance()">View Graph</button>
<canvas id="chart" width="600" height="300"></canvas>
</section>

<!-- ================= PDF REPORT ================= -->
<section>
<h3>PDF Exam Report</h3>
<select id="pdfExamSelect"></select>
<button onclick="generatePDF()">Download PDF</button>
</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getFirestore, collection, doc, getDocs, getDoc, updateDoc } 
from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const { jsPDF } = window.jspdf;

const firebaseConfig = {
  apiKey:"AIzaSyACtMRuTNPVqk15KUebcCccrqESv9hFEgE",
  authDomain:"science-cls.firebaseapp.com",
  projectId:"science-cls",
  storageBucket:"science-cls.appspot.com",
  messagingSenderId:"778012932104",
  appId:"1:778012932104:web:f997ad31edac581f0b79bd"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ---------- Load Exams ---------- */
async function loadExams() {
  examList.innerHTML = "";
  analyticsExam.innerHTML = "";
  pdfExamSelect.innerHTML = "";

  const snap = await getDocs(collection(db,"exams"));
  snap.forEach(d=>{
    const e=d.data();
    examList.innerHTML += `
      <div>
        <b>${e.title}</b> (${e.duration} min)
        <br>Status: ${e.isActive?"ðŸŸ¢ Open":"ðŸ”´ Closed"}
        <br><button onclick="toggleExam('${d.id}',${e.isActive})">
        ${e.isActive?"Close":"Open"}
        </button>
      </div>
    `;
    analyticsExam.innerHTML += `<option value="${d.id}">${e.title}</option>`;
    pdfExamSelect.innerHTML += `<option value="${d.id}">${e.title}</option>`;
  });
}

window.toggleExam = async (id,state)=>{
  await updateDoc(doc(db,"exams",id),{isActive:!state});
  loadExams();
};

/* ---------- Analytics ---------- */
window.loadAnalytics = async ()=>{
  const snap = await getDocs(
    collection(db,"leaderboard",analyticsExam.value,"results")
  );
  let scores=[];
  snap.forEach(d=>scores.push(d.data().score));
  analytics.innerHTML = scores.length
    ? `Attempts: ${scores.length}<br>
       Avg: ${(scores.reduce((a,b)=>a+b,0)/scores.length).toFixed(2)}<br>
       Max: ${Math.max(...scores)}<br>
       Min: ${Math.min(...scores)}`
    : "No attempts";
};

/* ---------- Student Graph ---------- */
let chart;
async function loadStudents(){
  const snap = await getDocs(collection(db,"students"));
  snap.forEach(d=>{
    studentSelect.innerHTML += `<option value="${d.id}">
      ${d.data().name}</option>`;
  });
}

window.loadStudentPerformance = async ()=>{
  let labels=[],data=[];
  const exams = await getDocs(collection(db,"exams"));
  for(const e of exams.docs){
    const r = await getDoc(
      doc(db,"leaderboard",e.id,"results",studentSelect.value)
    );
    if(r.exists()){
      labels.push(e.data().title);
      data.push(r.data().score);
    }
  }
  if(chart) chart.destroy();
  chart = new Chart(chartCanvas.getContext("2d"),{
    type:"line",
    data:{labels,datasets:[{label:"Score",data,borderWidth:3}]},
    options:{scales:{y:{beginAtZero:true}}}
  });
};

/* ---------- PDF REPORT ---------- */
window.generatePDF = async ()=>{
  const examId = pdfExamSelect.value;
  const examSnap = await getDoc(doc(db,"exams",examId));
  const examTitle = examSnap.data().title;

  const resultsSnap = await getDocs(
    collection(db,"leaderboard",examId,"results")
  );

  const pdf = new jsPDF();
  pdf.text(`Grade 10 Science - Exam Report`, 10, 10);
  pdf.text(`Exam: ${examTitle}`, 10, 20);

  let y = 30;
  pdf.text("Name", 10, y);
  pdf.text("Score", 150, y);
  y += 8;

  for(const r of resultsSnap.docs){
    const uid = r.id;
    const student = await getDoc(doc(db,"students",uid));
    if(!student.exists()) continue;

    pdf.text(student.data().name, 10, y);
    pdf.text(String(r.data().score), 150, y);
    y += 8;

    if(y > 280){ pdf.addPage(); y = 20; }
  }

  pdf.save(`${examTitle}_report.pdf`);
};

loadExams();
loadStudents();
</script>

</body>
</html>
