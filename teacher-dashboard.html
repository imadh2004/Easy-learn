<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Teacher Dashboard</title>
<style>
  body { font-family: Arial; background:#f4f6f8; padding:20px; }
  h2, h3, h4 { text-align:center; }
  input, button { padding:8px; margin:5px; }
  #studentList div, #examsList div, .questionDiv { background:white; padding:10px; margin:5px; border-radius:5px; box-shadow:0 1px 5px rgba(0,0,0,0.1); cursor:pointer; }
  #studentDetails { background:white; padding:15px; margin-top:15px; border-radius:10px; box-shadow:0 1px 5px rgba(0,0,0,0.1); }
  .examDiv { display:flex; justify-content: space-between; align-items: center; }
  .examDiv button { margin-left:5px; }
</style>
</head>
<body>

<h2>Teacher Dashboard</h2>

<!-- Leaderboard Button -->
<button onclick="goToLeaderboard()">üèÜ View Leaderboard</button>
<hr>

<!-- Exam Creation Section -->
<h3>Create Exam</h3>
<input type="text" id="examTitle" placeholder="Exam Title"><br>
<input type="number" id="examDuration" placeholder="Duration (minutes)"><br>

<div id="questionsContainer">
  <h4>Questions</h4>
  <div class="questionDiv">
    <input type="text" class="questionText" placeholder="Question"><br>
    <input type="text" class="option1" placeholder="Option A">
    <input type="text" class="option2" placeholder="Option B">
    <input type="text" class="option3" placeholder="Option C">
    <input type="text" class="option4" placeholder="Option D">
    <select class="answerSelect">
      <option value="0">A</option>
      <option value="1">B</option>
      <option value="2">C</option>
      <option value="3">D</option>
    </select>
  </div>
</div>
<button onclick="addQuestion()">Add Another Question</button><br>
<button onclick="createExam()">Create Exam</button>

<h4>Current Exams</h4>
<div id="examsList">Loading exams...</div>

<hr>

<!-- Student Management Section -->
<h3>Student Management</h3>
<input type="text" id="studentName" placeholder="Name with Initials">
<input type="text" id="studentIndex" placeholder="Index Number">
<input type="password" id="studentPassword" placeholder="Password">
<button onclick="addStudent()">Add Student</button>

<h4>Current Students</h4>
<div id="studentList">Loading students...</div>

<!-- Selected Student Details -->
<div id="studentDetails" style="display:none;">
  <h3 id="studentTitle"></h3>
  <div id="studentExams"></div>
  <canvas id="studentChart" width="400" height="200"></canvas>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getFirestore, collection, getDocs, doc, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey:"AIzaSyACtMRuTNPVqk15KUebcCccrqESv9hFEgE",
  authDomain:"science-cls.firebaseapp.com",
  projectId:"science-cls",
  storageBucket:"science-cls.appspot.com",
  messagingSenderId:"778012932104",
  appId:"1:778012932104:web:f997ad31edac581f0b79bd"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ---------- EXAM SECTION ----------
const examsDiv = document.getElementById("examsList");
const questionsContainer = document.getElementById("questionsContainer");

function addQuestion() {
  const div = document.createElement("div");
  div.className = "questionDiv";
  div.innerHTML = `
    <input type="text" class="questionText" placeholder="Question"><br>
    <input type="text" class="option1" placeholder="Option A">
    <input type="text" class="option2" placeholder="Option B">
    <input type="text" class="option3" placeholder="Option C">
    <input type="text" class="option4" placeholder="Option D">
    <select class="answerSelect">
      <option value="0">A</option>
      <option value="1">B</option>
      <option value="2">C</option>
      <option value="3">D</option>
    </select>
  `;
  questionsContainer.appendChild(div);
}

async function createExam(){
  const title = document.getElementById("examTitle").value.trim();
  const duration = parseInt(document.getElementById("examDuration").value);
  if(!title || !duration){ alert("Enter title and duration"); return; }

  const questionDivs = document.querySelectorAll(".questionDiv");
  const questions = [];
  questionDivs.forEach(div=>{
    const q = div.querySelector(".questionText").value.trim();
    const opts = [
      div.querySelector(".option1").value.trim(),
      div.querySelector(".option2").value.trim(),
      div.querySelector(".option3").value.trim(),
      div.querySelector(".option4").value.trim()
    ];
    const ans = parseInt(div.querySelector(".answerSelect").value);
    if(q && opts.every(o=>o)) questions.push({q, options:opts, answer:ans});
  });

  if(questions.length===0){ alert("Add at least one question"); return; }

  const examRef = doc(collection(db,"exams"));
  await setDoc(examRef,{title,duration,questions,createdAt:Date.now(), active:false});
  alert("Exam created!");
  document.getElementById("examTitle").value='';
  document.getElementById("examDuration").value='';
  questionsContainer.innerHTML=`<h4>Questions</h4><div class="questionDiv">
    <input type="text" class="questionText" placeholder="Question"><br>
    <input type="text" class="option1" placeholder="Option A">
    <input type="text" class="option2" placeholder="Option B">
    <input type="text" class="option3" placeholder="Option C">
    <input type="text" class="option4" placeholder="Option D">
    <select class="answerSelect">
      <option value="0">A</option>
      <option value="1">B</option>
      <option value="2">C</option>
      <option value="3">D</option>
    </select>
  </div>`;
  loadExams();
}

async function toggleExam(examId, currentStatus){
  const examRef = doc(db,"exams",examId);
  await updateDoc(examRef,{active: !currentStatus});
  loadExams();
}

async function loadExams(){
  examsDiv.innerHTML='';
  const snapshot = await getDocs(collection(db,"exams"));
  snapshot.forEach(snap=>{
    const data = snap.data();
    const div = document.createElement("div");
    div.className = "examDiv";

    const titleSpan = document.createElement("span");
    titleSpan.textContent = `${data.title} - Duration: ${data.duration} min - ${data.active ? "üü¢ Active" : "üî¥ Inactive"}`;

    const btn = document.createElement("button");
    btn.textContent = data.active ? "Stop" : "Start";
    btn.addEventListener('click', async ()=>{
      await toggleExam(snap.id, data.active);
    });

    const btnContainer = document.createElement("div");
    btnContainer.appendChild(btn);

    div.appendChild(titleSpan);
    div.appendChild(btnContainer);
    examsDiv.appendChild(div);
  });
}

// ---------- STUDENT MANAGEMENT ----------
const studentListDiv = document.getElementById("studentList");
const studentDetailsDiv = document.getElementById("studentDetails");
const studentExamsDiv = document.getElementById("studentExams");
let chartInstance = null;

async function loadStudents() {
  studentListDiv.innerHTML = '';
  const studentsSnap = await getDocs(collection(db,"students"));
  studentsSnap.forEach(snap=>{
    const data = snap.data();
    const div = document.createElement("div");
    div.textContent = `${data.name} (${data.index})`;
    div.onclick = ()=>showStudentDetails(snap.id,data.name);
    studentListDiv.appendChild(div);
  });
}

async function addStudent(){
  const name = document.getElementById("studentName").value.trim();
  let index = document.getElementById("studentIndex").value.trim();
  const password = document.getElementById("studentPassword").value;
  if(!name || !index || !password){ alert("All fields required"); return; }

  index = index.replace(/\s+/g,''); 
  const email = `easylearn${index}@example.com`;

  try {
    const userCredential = await createUserWithEmailAndPassword(auth,email,password);
    const uid = userCredential.user.uid;

    await setDoc(doc(db,"students",uid),{
      name, index, attempts:{}, createdAt:Date.now()
    });

    alert("Student added!");
    document.getElementById("studentName").value='';
    document.getElementById("studentIndex").value='';
    document.getElementById("studentPassword").value='';
    loadStudents();
  } catch(err){
    console.error(err);
    alert("Error adding student: " + err.message);
  }
}

loadStudents();
window.addStudent = addStudent;

// ---------- SHOW STUDENT DETAILS WITH PERCENTAGE ----------
async function showStudentDetails(uid,name){
  studentDetailsDiv.style.display='block';
  document.getElementById("studentTitle").textContent = `Student: ${name}`;
  studentExamsDiv.innerHTML = '';
  
  const studentSnap = await getDoc(doc(db,"students",uid));
  const studentData = studentSnap.data();
  if(!studentData || !studentData.attempts){
    studentExamsDiv.textContent = "No exam attempts yet.";
    if(chartInstance) chartInstance.destroy();
    return;
  }

  const attempts = studentData.attempts;
  const labels = [];
  const scores = [];

  for(const examId in attempts){
    const rawScore = attempts[examId];
    const examSnap = await getDoc(doc(db,"exams",examId));
    if(examSnap.exists()){
      const examData = examSnap.data();
      const totalQuestions = examData.questions.length;
      const percentage = (rawScore / totalQuestions) * 100;

      labels.push(examData.title);
      scores.push(percentage);

      const div = document.createElement("div");
      div.textContent = `${examData.title}: ${percentage.toFixed(2)}%`;
      studentExamsDiv.appendChild(div);
    }
  }

  const ctx = document.getElementById("studentChart").getContext("2d");
  if(chartInstance) chartInstance.destroy();
  chartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Exam Scores (%)',
        data: scores,
        fill: false,
        borderColor: 'blue',
        tension: 0.1
      }]
    },
    options: {
      responsive: true,
      scales: { y: { min: 0, max: 100 } }
    }
  });
}

// ---------- LEADERBOARD NAVIGATION ----------
window.goToLeaderboard = () => {
  window.location.href = "leaderboard.html";
};

loadExams();

</script>
</body>
</html>
