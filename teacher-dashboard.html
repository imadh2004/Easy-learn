<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Teacher Dashboard</title>
<style>
  body { font-family: Arial; background:#f4f6f8; padding:20px; }
  h2, h3, h4 { text-align:center; }
  input, button, select { padding:8px; margin:5px; }
  #studentList div, #examsList div { background:white; padding:10px; margin:5px; border-radius:5px; box-shadow:0 1px 5px rgba(0,0,0,0.1); }
</style>
</head>
<body>

<h2>Teacher Dashboard</h2>

<!-- Exam Creation Section -->
<h3>Create Exam</h3>
<input type="text" id="examTitle" placeholder="Exam Title">
<input type="number" id="examDuration" placeholder="Duration (minutes)">
<textarea id="examQuestions" placeholder='Enter questions as JSON, e.g., [{"q":"Q1","options":["A","B","C"],"answer":0}]' style="width:100%;height:80px;"></textarea>
<button onclick="createExam()">Create Exam</button>

<h4>Current Exams</h4>
<div id="examsList">Loading exams...</div>

<hr>

<!-- Student Management Section -->
<h3>Student Management</h3>
<input type="text" id="studentName" placeholder="Name with Initials">
<input type="text" id="studentIndex" placeholder="Index Number">
<input type="password" id="studentPassword" placeholder="Password">
<button onclick="addStudent()">Add Student</button>

<h4>Current Students</h4>
<div id="studentList">Loading students...</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getFirestore, collection, getDocs, doc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey:"AIzaSyACtMRuTNPVqk15KUebcCccrqESv9hFEgE",
  authDomain:"science-cls.firebaseapp.com",
  projectId:"science-cls",
  storageBucket:"science-cls.appspot.com",
  messagingSenderId:"778012932104",
  appId:"1:778012932104:web:f997ad31edac581f0b79bd"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// --------- EXAM SECTION ---------
const examsDiv = document.getElementById("examsList");

async function createExam(){
  const title = document.getElementById("examTitle").value.trim();
  const duration = parseInt(document.getElementById("examDuration").value);
  let questions;
  try { questions = JSON.parse(document.getElementById("examQuestions").value); } 
  catch(e){ alert("Invalid questions JSON"); return; }

  if(!title || !duration || !questions){ alert("All fields required"); return; }

  const examRef = doc(collection(db,"exams"));
  await setDoc(examRef,{
    title: title,
    duration: duration,
    questions: questions,
    createdAt: Date.now()
  });

  alert("Exam created!");
  document.getElementById("examTitle").value='';
  document.getElementById("examDuration").value='';
  document.getElementById("examQuestions").value='';
  loadExams();
}

async function loadExams(){
  examsDiv.innerHTML='';
  const snapshot = await getDocs(collection(db,"exams"));
  snapshot.forEach(snap=>{
    const data = snap.data();
    const div = document.createElement("div");
    div.textContent = `${data.title} - Duration: ${data.duration} min`;
    examsDiv.appendChild(div);
  });
}

loadExams();

// --------- STUDENT MANAGEMENT SECTION ---------
const studentListDiv = document.getElementById("studentList");

async function loadStudents() {
  studentListDiv.innerHTML = '';
  const studentsSnap = await getDocs(collection(db,"students"));
  studentsSnap.forEach(snap=>{
    const data = snap.data();
    const div = document.createElement("div");
    div.textContent = `${data.name} (${data.index})`;
    const removeBtn = document.createElement("button");
    removeBtn.textContent = "Remove";
    removeBtn.onclick = ()=>removeStudent(snap.id);
    div.appendChild(removeBtn);
    studentListDiv.appendChild(div);
  });
}

async function addStudent(){
  const name = document.getElementById("studentName").value.trim();
  const index = document.getElementById("studentIndex").value.trim();
  const password = document.getElementById("studentPassword").value;

  if(!name || !index || !password){
    alert("All fields are required!");
    return;
  }

  const email = `easylearn(${index})@example.com`;

  try {
    const userCredential = await createUserWithEmailAndPassword(auth,email,password);
    const uid = userCredential.user.uid;

    await setDoc(doc(db,"students",uid),{
      name: name,
      index: index,
      attempts: {},
      createdAt: Date.now()
    });

    alert("Student added!");
    document.getElementById("studentName").value='';
    document.getElementById("studentIndex").value='';
    document.getElementById("studentPassword").value='';
    loadStudents();

  } catch(err){
    console.error(err);
    alert("Error adding student: " + err.message);
  }
}

async function removeStudent(uid){
  if(!confirm("Are you sure you want to remove this student?")) return;

  try {
    await deleteDoc(doc(db,"students",uid));
    alert("Student removed. Please remove from Firebase Authentication manually if needed.");
    loadStudents();
  } catch(err){
    console.error(err);
    alert("Error removing student: " + err.message);
  }
}

loadStudents();

window.addStudent = addStudent;
window.removeStudent = removeStudent;

</script>
</body>
</html>
