<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Teacher Dashboard</title>
<style>
body{font-family:Arial;background:#f4f6f8;padding:20px}
h2,h3,h4{text-align:center}
input,button{padding:8px;margin:5px}
#studentList div,#examsList div,.questionDiv{
  background:#fff;padding:10px;margin:6px;border-radius:6px;
  box-shadow:0 1px 5px rgba(0,0,0,.1)
}
.examDiv{display:flex;justify-content:space-between;align-items:center}
</style>
</head>
<body>

<h2>Teacher Dashboard</h2>
<button onclick="goToLeaderboard()">ğŸ† View Leaderboard</button>
<hr>

<h3>Create Exam</h3>
<input id="examTitle" placeholder="Exam Title"><br>
<input id="examDuration" type="number" placeholder="Duration (minutes)"><br>

<div id="questionsContainer">
<h4>Questions</h4>
<div class="questionDiv">
<input class="questionText" placeholder="Question"><br>
<input class="option1" placeholder="Option A">
<input class="option2" placeholder="Option B">
<input class="option3" placeholder="Option C">
<input class="option4" placeholder="Option D">
<select class="answerSelect">
<option value="0">A</option>
<option value="1">B</option>
<option value="2">C</option>
<option value="3">D</option>
</select>
</div>
</div>

<button onclick="addQuestion()">Add Question</button>
<button onclick="createExam()">Create Exam</button>

<h4>Current Exams</h4>
<div id="examsList">Loading exams...</div>

<hr>

<h3>Student Management</h3>
<input id="studentName" placeholder="Name">
<input id="studentIndex" placeholder="Index">
<input id="studentPassword" type="password" placeholder="Password">
<button onclick="addStudent()">Add Student</button>

<h4>Current Students</h4>
<div id="studentList">Loading students...</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import {
  getFirestore, collection, getDocs,
  doc, setDoc, getDoc, updateDoc
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

/* ---------------- FIREBASE ---------------- */
const firebaseConfig = {
  apiKey:"AIzaSyACtMRuTNPVqk15KUebcCccrqESv9hFEgE",
  authDomain:"science-cls.firebaseapp.com",
  projectId:"science-cls",
  appId:"1:778012932104:web:f997ad31edac581f0b79bd"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ---------------- DOM ---------------- */
const examsDiv = document.getElementById("examsList");
const studentListDiv = document.getElementById("studentList");
const questionsContainer = document.getElementById("questionsContainer");

/* ---------------- QUESTIONS ---------------- */
window.addQuestion = () => {
  const d=document.createElement("div");
  d.className="questionDiv";
  d.innerHTML=`
  <input class="questionText" placeholder="Question"><br>
  <input class="option1" placeholder="Option A">
  <input class="option2" placeholder="Option B">
  <input class="option3" placeholder="Option C">
  <input class="option4" placeholder="Option D">
  <select class="answerSelect">
    <option value="0">A</option>
    <option value="1">B</option>
    <option value="2">C</option>
    <option value="3">D</option>
  </select>`;
  questionsContainer.appendChild(d);
};

/* ---------------- CREATE EXAM ---------------- */
window.createExam = async () => {
  try{
    const title=examTitle.value.trim();
    const duration=Number(examDuration.value);
    if(!title||!duration) return alert("Enter title & duration");

    const questions=[];
    document.querySelectorAll(".questionDiv").forEach(q=>{
      const text=q.querySelector(".questionText").value.trim();
      const opts=[
        q.querySelector(".option1").value,
        q.querySelector(".option2").value,
        q.querySelector(".option3").value,
        q.querySelector(".option4").value
      ];
      const ans=Number(q.querySelector(".answerSelect").value);
      if(text && opts.every(o=>o)) questions.push({q:text,options:opts,answer:ans});
    });

    if(!questions.length) return alert("Add at least one question");

    await setDoc(doc(collection(db,"exams")),{
      title,duration,questions,
      active:false,
      createdAt:Date.now()
    });

    alert("Exam created");
    loadExams();
  }catch(e){
    console.error(e);
    alert("Create exam failed");
  }
};

/* ---------------- LOAD EXAMS ---------------- */
async function loadExams(){
  examsDiv.innerHTML="";
  const snap=await getDocs(collection(db,"exams"));
  const exams=[];
  snap.forEach(s=>exams.push({id:s.id,...s.data()}));
  exams.sort((a,b)=>a.createdAt-b.createdAt);

  exams.forEach(e=>{
    const d=document.createElement("div");
    d.className="examDiv";
    d.innerHTML=`
      <span>${e.title} â€” ${e.active?"ğŸŸ¢ Active":"ğŸ”´ Inactive"}</span>
      <button>${e.active?"Stop":"Start"}</button>`;
    d.querySelector("button").onclick=()=>toggleExam(e.id);
    examsDiv.appendChild(d);
  });
}

async function toggleExam(id){
  const ref=doc(db,"exams",id);
  const snap=await getDoc(ref);
  await updateDoc(ref,{active:!snap.data().active});
  loadExams();
}

/* ---------------- STUDENTS ---------------- */
window.addStudent = async () => {
  try{
    const name=studentName.value.trim();
    const index=studentIndex.value.trim();
    const pass=studentPassword.value;
    if(!name||!index||!pass) return alert("All fields required");

    const email=`student${index}@example.com`;
    const u=await createUserWithEmailAndPassword(auth,email,pass);

    await setDoc(doc(db,"students",u.user.uid),{
      name,index,attempts:{},createdAt:Date.now()
    });

    alert("Student added");
    loadStudents();
  }catch(e){
    console.error(e);
    alert("Student creation failed");
  }
};

async function loadStudents(){
  studentListDiv.innerHTML="";
  const snap=await getDocs(collection(db,"students"));
  snap.forEach(s=>{
    const d=document.createElement("div");
    d.textContent=`${s.data().name} (${s.data().index})`;
    studentListDiv.appendChild(d);
  });
}

/* ---------------- INIT ---------------- */
window.goToLeaderboard=()=>location.href="leaderboard.html";

loadExams();
loadStudents();

</script>
</body>
</html>
