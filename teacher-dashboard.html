<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Teacher Dashboard</title>
<style>
  body { font-family: Arial, sans-serif; background:#f4f6f8; padding:20px; color: #333; }
  .container { max-width: 800px; margin: 0 auto; }
  h2, h3, h4 { text-align:center; }
  
  /* Form Styling */
  .section { background:white; padding:20px; margin-bottom:20px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
  input, select, button { padding:10px; margin:5px 0; border: 1px solid #ddd; border-radius: 5px; }
  input[type="text"], input[type="number"] { width: calc(100% - 22px); }
  
  .questionDiv {
    background:#fafafa;
    padding:15px;
    margin:10px 0;
    border-left: 5px solid #007bff;
    border-radius:5px;
  }
  
  /* Exam List Styling */
  .exam-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: white;
    padding: 15px;
    margin: 10px 0;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  }
  .btn-create { background: #28a745; color: white; border: none; cursor: pointer; width: 100%; font-size: 16px; }
  .btn-add { background: #007bff; color: white; border: none; cursor: pointer; }
  .btn-delete { background: #dc3545; color: white; border: none; cursor: pointer; padding: 5px 10px; }
  .btn-toggle { background: #6c757d; color: white; border: none; cursor: pointer; padding: 5px 10px; }
  .status-active { color: #28a745; font-weight: bold; }
  .status-inactive { color: #dc3545; font-weight: bold; }
</style>
</head>
<body>

<div class="container">
  <h2>Teacher Dashboard</h2>

  <div class="section">
    <h3>Create New Exam</h3>
    <input type="text" id="examTitle" placeholder="Exam Title (e.g. Physics Quiz 1)">
    <input type="number" id="examDuration" placeholder="Duration (minutes)">

    <div id="questionsContainer">
      <h4>Questions</h4>
      <div class="questionDiv">
        <input type="text" class="questionText" placeholder="Question Text"><br>
        <input type="text" class="option1" placeholder="Option A">
        <input type="text" class="option2" placeholder="Option B"><br>
        <input type="text" class="option3" placeholder="Option C">
        <input type="text" class="option4" placeholder="Option D"><br>
        <label>Correct Answer:</label>
        <select class="answerSelect">
          <option value="0">A</option>
          <option value="1">B</option>
          <option value="2">C</option>
          <option value="3">D</option>
        </select>
      </div>
    </div>

    <button class="btn-add" onclick="addQuestion()">‚ûï Add Another Question</button>
    <button class="btn-create" onclick="createExam()">üíæ Save and Create Exam</button>
  </div>

  <div class="section">
    <h3>Current Exams</h3>
    <div id="examsList">Loading exams...</div>
  </div>
  
  <button onclick="location.href='index.html'">Logout</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getFirestore, collection, getDocs, doc, addDoc, deleteDoc, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyACtMRuTNPVqk15KUebcCccrqESv9hFEgE",
  authDomain: "science-cls.firebaseapp.com",
  projectId: "science-cls",
  storageBucket: "science-cls.appspot.com",
  messagingSenderId: "778012932104",
  appId: "1:778012932104:web:f997ad31edac581f0b79bd"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const examsDiv = document.getElementById("examsList");
const questionsContainer = document.getElementById("questionsContainer");

/* ---------- ADD QUESTION TO UI ---------- */
function addQuestion() {
  const div = document.createElement("div");
  div.className = "questionDiv";
  div.innerHTML = `
    <input type="text" class="questionText" placeholder="Question Text"><br>
    <input type="text" class="option1" placeholder="Option A">
    <input type="text" class="option2" placeholder="Option B"><br>
    <input type="text" class="option3" placeholder="Option C">
    <input type="text" class="option4" placeholder="Option D"><br>
    <label>Correct Answer:</label>
    <select class="answerSelect">
      <option value="0">A</option>
      <option value="1">B</option>
      <option value="2">C</option>
      <option value="3">D</option>
    </select>
  `;
  questionsContainer.appendChild(div);
}

/* ---------- SAVE EXAM TO FIRESTORE ---------- */
async function createExam(){
  const title = document.getElementById("examTitle").value.trim();
  const duration = Number(document.getElementById("examDuration").value);

  if(!title || !duration){
    alert("Please enter a title and duration.");
    return;
  }

  const questionDivs = document.querySelectorAll(".questionDiv");
  const questions = [];

  questionDivs.forEach(div => {
    const q = div.querySelector(".questionText").value.trim();
    const options = [
      div.querySelector(".option1").value.trim(),
      div.querySelector(".option2").value.trim(),
      div.querySelector(".option3").value.trim(),
      div.querySelector(".option4").value.trim()
    ];
    const answer = Number(div.querySelector(".answerSelect").value);

    if(q && options.every(o => o !== "")){
      questions.push({ q, options, answer });
    }
  });

  if(questions.length === 0){
    alert("Please complete at least one question.");
    return;
  }

  try {
    await addDoc(collection(db, "exams"), {
      title,
      duration,
      questions,
      active: false,        // Required for Student Dashboard logic
      createdAt: Date.now() // Required for sorting
    });

    alert("Exam created successfully!");
    location.reload(); 
  } catch (e) {
    console.error("Error: ", e);
    alert("Save failed. Check console.");
  }
}

/* ---------- LOAD AND DISPLAY EXAMS ---------- */
async function loadExams(){
  examsDiv.innerHTML = "Loading...";
  // Query to show newest first
  const q = query(collection(db, "exams"), orderBy("createdAt", "desc"));
  const snap = await getDocs(q);
  examsDiv.innerHTML = "";
  
  if (snap.empty) {
    examsDiv.innerHTML = "No exams found.";
    return;
  }

  snap.forEach(docSnap => {
    const d = docSnap.data();
    const id = docSnap.id;
    const div = document.createElement("div");
    div.className = "exam-item";
    
    div.innerHTML = `
      <div>
        <strong>${d.title}</strong><br>
        <small>${d.questions.length} Qs | ${d.duration} mins</small><br>
        Status: <span class="${d.active ? 'status-active' : 'status-inactive'}">${d.active ? 'Active' : 'Inactive'}</span>
      </div>
      <div>
        <button class="btn-toggle" onclick="toggleExam('${id}', ${d.active})">${d.active ? 'Deactivate' : 'Activate'}</button>
        <button class="btn-delete" onclick="deleteExam('${id}')">üóëÔ∏è</button>
      </div>
    `;
    examsDiv.appendChild(div);
  });
}

/* ---------- TOGGLE EXAM STATUS ---------- */
window.toggleExam = async function(id, currentStatus) {
  const examRef = doc(db, "exams", id);
  await updateDoc(examRef, { active: !currentStatus });
  loadExams();
};

/* ---------- DELETE EXAM ---------- */
window.deleteExam = async function(id) {
  if(confirm("Are you sure you want to delete this exam?")) {
    await deleteDoc(doc(db, "exams", id));
    loadExams();
  }
};

// üîë EXPORT FUNCTIONS TO WINDOW FOR HTML BUTTONS
window.addQuestion = addQuestion;
window.createExam = createExam;

// Initialize
loadExams();

</script>
</body>
</html>
