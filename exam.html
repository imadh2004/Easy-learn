<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Exam</title>
  <style>
    body{font-family:Arial;background:#f4f6f8;padding:20px}
    .question{background:#fff;padding:15px;margin:10px 0;border-radius:8px}
    button{padding:6px 12px;margin-top:10px}
  </style>
</head>
<body>

<h2>Exam</h2>
<div id="examContent">Loading exam...</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth,onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey:"AIzaSyACtMRuTNPVqk15KUebcCccrqESv9hFEgE",
  authDomain:"science-cls.firebaseapp.com",
  projectId:"science-cls",
  appId:"1:778012932104:web:f997ad31edac581f0b79bd"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

onAuthStateChanged(auth, async user => {
  if (!user) {
    window.location.href = "index.html";
    return;
  }

  const uid = user.uid;
  const studentRef = doc(db,"students",uid);

  // AUTO-CREATE student document if missing
  const studentSnap = await getDoc(studentRef);
  if (!studentSnap.exists()) {
    await setDoc(studentRef,{
      name: "Unknown Student",
      index: "",
      attempts: {},
      createdAt: Date.now()
    });
    console.log("Student doc auto-created");
  }

  loadExam(uid);
});

async function loadExam(uid) {
  const examId = localStorage.getItem("currentExamId");
  if (!examId) {
    alert("No exam selected");
    window.location.href = "student-dashboard.html";
    return;
  }

  const examRef = doc(db,"exams",examId);
  const examSnap = await getDoc(examRef);

  if (!examSnap.exists()) {
    alert("Exam not found");
    window.location.href = "student-dashboard.html";
    return;
  }

  const examData = examSnap.data();

  // Check if already attempted
  const studentSnap = await getDoc(doc(db,"students",uid));
  const attempts = studentSnap.data().attempts || {};
  if (attempts[examId]) {
    alert("You have already attempted this exam");
    window.location.href = "student-dashboard.html";
    return;
  }

  // Render questions
  const container = document.getElementById("examContent");
  container.innerHTML = `<h3>${examData.title}</h3><p>Duration: ${examData.duration} min</p>`;
  examData.questions.forEach((q,i)=>{
    const div = document.createElement("div");
    div.className = "question";
    div.innerHTML = `<b>Q${i+1}: ${q.q}</b><br>` +
      q.options.map((opt,j)=>`<input type="radio" name="q${i}" value="${j}"> ${opt}<br>`).join("");
    container.appendChild(div);
  });

  // Submit button
  const submitBtn = document.createElement("button");
  submitBtn.textContent = "Submit Exam";
  submitBtn.onclick = async ()=>{
    let score = 0;
    examData.questions.forEach((q,i)=>{
      const selected = document.querySelector(`input[name="q${i}"]:checked`);
      if(selected && parseInt(selected.value) === q.answer) score++;
    });

    // Save attempt
    const studentRef = doc(db,"students",uid);
    await setDoc(studentRef, { attempts: { [examId]: score } }, { merge:true });

    alert(`Exam submitted! Your score: ${score}`);
    window.location.href = "student-dashboard.html";
  };
  container.appendChild(submitBtn);
}
</script>

</body>
</html>
