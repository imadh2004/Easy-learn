<!DOCTYPE html>
<html>
<head>
<title>Leaderboard</title>
<style>
body{font-family:Arial;background:#f4f6f8;padding:20px}
table{width:100%;background:#fff;border-collapse:collapse}
th,td{border:1px solid #ccc;padding:10px;text-align:center}
th{background:#007bff;color:white}
select{margin-bottom:10px;padding:5px}
</style>
</head>
<body>

<h2>Leaderboard</h2>
<select id="examSelect"></select>

<table>
<thead>
  <tr>
    <th>Rank</th>
    <th>Name</th>
    <th>Score</th>
    <th>Percentage</th>
  </tr>
</thead>
<tbody id="rows"></tbody>
</table>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getFirestore, collection, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey:"AIzaSyACtMRuTNPVqk15KUebcCccrqESv9hFEgE",
  authDomain:"science-cls.firebaseapp.com",
  projectId:"science-cls",
  appId:"1:778012932104:web:f997ad31edac581f0b79bd"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const examSelect = document.getElementById("examSelect");
const rows = document.getElementById("rows");

let examsData = {};
let examOrder = [];

// Fetch exams for dropdown and store questions length
async function loadExams(){
  const examsSnap = await getDocs(collection(db,"exams"));
  examsSnap.forEach(e=>{
    const data = e.data();
    examsData[e.id] = data;
    examOrder.push({id: e.id, createdAt: data.createdAt});
  });

  // Sort by createdAt ascending
  examOrder.sort((a,b) => a.createdAt - b.createdAt);

  examOrder.forEach(exam=>{
    examSelect.innerHTML += `<option value="${exam.id}">${examsData[exam.id].title}</option>`;
  });

  // Select last exam by default
  if(examOrder.length>0){
    const lastExamId = examOrder[examOrder.length-1].id;
    examSelect.value = lastExamId;
    loadLeaderboard();
  }
}

examSelect.onchange = loadLeaderboard;

// Load leaderboard in real-time
let unsubscribe = null;

function loadLeaderboard(){
  if(unsubscribe) unsubscribe();

  const examId = examSelect.value;
  if(!examId) return;

  const totalQuestions = examsData[examId]?.questions?.length || 1;
  const studentsCol = collection(db,"students");

  unsubscribe = onSnapshot(studentsCol, snapshot=>{
    let list = [];
    snapshot.forEach(s=>{
      const d = s.data();
      const score = Number(d.attempts?.[examId]?.score || 0);
      const percentage = ((score / totalQuestions) * 100).toFixed(2);
      list.push({ name: d.name, score, percentage });
    });

    // Sort descending by score
    list.sort((a,b)=>b.score - a.score);

    rows.innerHTML = "";
    if(list.length===0){
      rows.innerHTML = `<tr><td colspan="4">No students have attempted this exam yet.</td></tr>`;
    } else {
      list.forEach((s,i)=>{
        rows.innerHTML += `<tr>
          <td>${i+1}</td>
          <td>${s.name}</td>
          <td>${s.score}</td>
          <td>${s.percentage}%</td>
        </tr>`;
      });
    }
  });
}

// Initial load
loadExams();
</script>
</body>
</html>
